<!DOCTYPE html>

<html lang="en">

	<head>

		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

		<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
		<link rel="stylesheet" href="static/style.css">

		<script src="static/handlebars-v2.0.0.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
		<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

	</head>

	<body>

		<!-- Nav -->

		<nav style="display:none;" class="row-fluid navbar navbar-fixed-top" role="navigation">

			<div class="container">

				<div class="row">
					
					<form id="form-sub" role="form">
						<div class="col-xs-2 col-md-1 homelink">
							<a href="/"><span class="glyphicon glyphicon-home"></span></a>
						</div>
						<div class="col-xs-10 col-md-3">
							<select id="select-sub" placeholder="Select Subreddit" class="form-control">
								<option selected="selected">Front Page</option>
							    
							</select>
						</div>
						<div class="col-xs-6 col-md-3">
							
							<input type="input" class="form-control" id="input-sub" placeholder="Enter Subreddit">
							
					
						</div>
						<div class="col-xs-2 col-md-1">
							<button type="submit" class="btn btn-primary"><span class="glyphicon glyphicon-search"></span></button>
						</div>
						<div class="col-xs-4 col-md-2">
							<select id="select-sort" class="form-control">
							    <option selected="selected" value="hot">hot</option>
							    <option value="new">new</option>
							    <option value="day">top today</option>
							    <option value="week">top this week</option>
							    <option value="month">top this month</option>
							    <option value="year">top this year</option>]
							    <option value="all">top all time</option>
							</select>
						</div>
					</form>
					<div class="col-xs-0 col-md-2"></div>
				</div>
			</div>
		</nav>

		<!-- Grid -->

		<div id="mobile-spacer">
			<div class='hiden-md hidden-lg' style='height:44px;'></div>
		</div>

		<div id="main" class="container-fluid">
			<div class="row">
				<div id="left-menu" class="col-xs-2">
				</div>
				<div id="gallery" class="col-xs-10">
					<div class="row">
						<div id="col-1" class='col-xs-3'></div>
						<div id="col-2" class='col-xs-3'></div>
						<div id="col-3" class='col-xs-3'></div>
						<div id="col-4" class='col-xs-3'></div>
					</div>
				</div>
			</div>
		</div>

		<!--Start Google Analytics-->

		<script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		  ga('create', 'UA-53022536-1', 'auto');
		  ga('require', 'displayfeatures');
		  ga('send', 'pageview');

		</script>

	</body>

</html>

{% raw %}

 <script id="simple-template" type="text/x-handlebars-template">

	<div class="picbox">
		<a style="{{thumbnailHelper}}" target="_blank" href="{{url}}"><img src="{{{picHelper preview.images.0.resolutions}}}" /></a>
		<div class="col-xs-12 {{display}}" >

			<div class="row">
				<div class="col-xs-12">
					<a id="extlink" href="http://www.reddit.com/{{permalink}}" target="_blank">{{formatTitle title}}</a>
				</div>
			</div>

			<div class="row subreddit">
				<div class="col-xs-12">
					<a href="{{subreddit}}"><small>{{subreddit}}</small></a>
					<small><span class="glyphicon glyphicon-arrow-up"></span> {{ups}}</small>
					<small><span class="glyphicon glyphicon-comment"></span></a>{{num_comments}}</small>
				</div>
			</div>

			
		</div>
	</div>
	
 </script>

 {% endraw %}

<script id="source" language="javascript" type="text/javascript">

// ---- Handlebars Helpers

Handlebars.registerHelper("formatTitle", function(title){
	var textlimit = 60;
	return (title.length > textlimit) ? title.substring(0, textlimit) + "..." : title;
});


Handlebars.registerHelper("picHelper", function(resolutions){
	console.log(resolutions);
	if (resolutions.length > 1) {
		return resolutions[1]['url'];
	} else {
		return resolutions[0]['url'];
	}
});

// ----  Document Ready

$(document).ready(function() { 

	subs = [
		'nsfw'
		];

	sub = subs.join("+");
	after = null;
	count = 0;
	limit = 47;
	sort = "hot";
	loadSubDropdowns(subs);
	$("#load-div").show();

	getItems(sub, sort);
	
	
});

// ----  Event Handlers

// Clear input on focus
$("#input-sub").focus(function() {		
	$(this).attr("placeholder","");
});

// Subreddit form submit
$("#form-sub").submit(function(e) { 	
	e.preventDefault();
	sub = $("#input-sub").val();
	window.location.href = sub;
});

// Dropdown submit
$("#select-sub").change(function() { 	
	sub = $("#select-sub").find(":selected").text();
	window.location.href = sub;
});

// Dropdown submit
$("#select-sort").change(function() { 	
	sort = $("#select-sort").find(":selected").val();
	$("#load-div").show();
	refreshSub(sub, sort);
});

// Pic info box show
$(document).on("mouseenter", ".picbox", function(){  
	$(this).find(".infobox").show();
});

// Pic info box hide
$(document).on("mouseleave", ".picbox", function(){ 	
	$(this).find(".infobox").hide();
});

// Page scroller
$(window).scroll(function () {		
   if ($(window).scrollTop() >= $(document).height() - $(window).height() - 10) {	
   		$("#load-div").show();
		getItems(sub, sort);
   }
});

$(window).resize(function(){
	resizePics();
});

// Make picbox div a link
$(document).on("click", ".picbox", function(){ 		
  window.open = $(this).find("#extlink").attr("href"); 
});

// ----  Functions

function loadSubDropdowns(subs) {
	subs.forEach(function(sub) {
		$("#select-sub").append('<option value="">'+sub+'</option>');
	});
}

function refreshSub(sub, sort){
	count = 0;
	after = null;
	$("#main").empty();
	getItems(sub, sort);
}

function getItems(sub, sort){

	var subUrl 	= (sub == null ) ? "" : "r/"+sub;
	var limitUrl 	= "limit=" + limit;
	var afterUrl 	= (after == null) ? "" : "&after="+after;
	var countUrl 	= (count == 0) ? "" : "&count="+count;

	switch(sort) {
		case "hot":
			var sortType = "hot";
			var sortUrl = "sort=hot";
			break;
		case "new":
			var sortType = "new";
			var sortUrl = "sort=new";
			break;
		case "day":
			var sortType = "top";
			var sortUrl = "sort=top&t=day";
			break;
		case "week":
			var sortType = "top";
			var sortUrl = "sort=top&t=week";
			break;
		case "month":
			var sortType = "top";
			var sortUrl = "sort=top&t=month";
			break;
		case "year":
			var sortType = "top";
			var sortUrl = "sort=top&t=year";
			break;
		case "all":
			var sortType = "top";
			var sortUrl = "sort=top&t=all";
			break;
	}
	
	var url = "http://www.reddit.com/" + subUrl + "/" + sortType + "/.json?" + sortUrl + "&" + limitUrl + afterUrl + countUrl;

	$.getJSON( url, function(data) {
		listItems(data, false);
		$("#load-div").hide();
	}).fail(function(data) {
		$("#main").empty();
		$("#main").append("<br />Could not get data from subreddit '"+sub+"'. Please make sure that this subreddit exists, or try again in a few minutes.");
	});
	}

function listItems(json, printtext){

	// Compile handlebars template

	var raw_template = $('#simple-template').html();
	var template = Handlebars.compile(raw_template);
 
	$.each(json.data.children, function(i,element){ // Iterate through JSON object

		if((count % 4) == 0){
			var placeHolder = $("#col-1");
		} else if ((count % 4) == 1){
			var placeHolder = $("#col-2");
		} else if ((count % 4) == 2){
			var placeHolder = $("#col-3");
		} else {
			var placeHolder = $("#col-4");
		}

		if((count % 12) == 0){

			$(placeHolder).append("<div class='row'>");

		}		

		if(element.data.thumbnail == "" || element.data.thumbnail =="self" || element.data.thumbnail =="default"){ // Don't display thumbnail for self posts and posts with no image
			element.data.display = "infobox-nojs";
			element.data.thumbnailHelper = 'display:none;';
			element.data.ismedia = false;
		} else {
			element.data.display = "infobox";
			element.data.thumbnailHelper = null;
			element.data.ismedia = true;
		}

		if(element.data.thumbnail == "nsfw"){
			element.data.thumbnail = "images/nsfw.png"
		}

		if(printtext == true){
			if (element.data.stickied == false){
				var html = template(element.data); // Generate the HTML for each post
				placeHolder.append(html); // Render the posts into the page
				after = element.data.name;
				count++;
			}
		} else {
			if(element.data.ismedia == true){
				var html = template(element.data); // Generate the HTML for each post
				placeHolder.append(html); // Render the posts into the page
				after = element.data.name;
				count++;
			}
		}

		if((count % 12) == (11)){
			$(placeHolder).append("</div>");
		}	
	});
}

</script>
